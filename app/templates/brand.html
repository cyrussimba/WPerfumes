<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title id="brandTitle">Brand Fragrances</title>

    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/announcements.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/footer.css') }}">

    <style>
        :root {
            --light-brown: #d7ccc8;
            --dark-text: #3e2723;
            --light-silver: #e0e0e0;
            --white-bg: #ffffff;
            --dark-accent: #000000;
            --footer-link-color: #5d4037;
            --light-green: #c8e6c9;
            --sale-red: #e53935;
            --primary-white: #ffffff;

            /* New button tokens to match brand_detail and provided image */
            --cta-primary-bg: #2d8f7c;
            /* teal/green used for Buy Now */
            --cta-primary-hover: #277862;
            --cta-primary-color: #ffffff;
            --cta-secondary-bg: #f5f5f5;
            /* light gray for Wishlist */
            --cta-secondary-border: #e6e6e6;
            --cta-secondary-color: #bdbdbd;
            --btn-radius: 8px;
            --btn-padding-sm: 8px 14px;
            --btn-font-size: 0.95rem;
            --btn-shadow: 0 6px 18px rgba(0, 0, 0, 0.06);
        }

        /* predictable sizing */
        *,
        *::before,
        *::after {
            box-sizing: border-box;
        }

        body {
            font-family: 'Georgia', serif;
            background-color: var(--white-bg);
            color: var(--dark-text);
            margin: 0;
        }

        .navbar {
            background-color: var(--light-brown);
            padding: 10px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            border-bottom: 1px solid var(--light-silver);
        }

        .navbar-left {
            display: flex;
            align-items: center;
        }

        .brand-logo {
            font-size: 28px;
            font-weight: bold;
            color: var(--dark-text);
            text-decoration: none;
            letter-spacing: 1px;
            margin-right: 30px;
        }

        .nav-tabs {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
        }

        .nav-tabs li a {
            text-decoration: none;
            color: var(--dark-text);
            padding: 10px 18px;
            display: block;
            border-radius: 4px;
            transition: background-color 0.3s, color 0.3s;
        }

        .nav-tabs li a:hover {
            background-color: var(--light-green);
            color: var(--dark-accent);
        }

        .navbar-center {
            flex-grow: 1;
            max-width: 450px;
            margin: 0 20px;
        }

        .search-container input[type="text"] {
            width: 100%;
            padding: 8px 18px;
            border: 1px solid var(--light-silver);
            background-color: var(--light-silver);
            border-radius: 20px;
            outline: none;
            font-size: 14px;
            color: var(--dark-text);
        }

        .navbar-right {
            display: flex;
            align-items: center;
        }

        .content-container {
            max-width: 1200px;
            margin: 15px auto 15px auto !important;
            padding: 0 10px !important;
        }

        h1#brandHeader {
            font-size: 1.5em !important;
            margin-bottom: 15px !important;
            padding-bottom: 5px !important;
        }

        #brandDesc {
            margin-bottom: 10px !important;
            font-size: 1em !important;
        }

        .discount-info {
            background: #f1c40f1a;
            color: #b8860b;
            border-radius: 4px;
            padding: 7px 10px;
            font-size: 1em;
            font-weight: 500;
            margin-bottom: 14px;
            display: inline-flex;
            gap: 8px;
            align-items: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }

        /* Product grid */
        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 10px !important;
            grid-auto-rows: minmax(280px, auto);
            align-items: start;
            justify-items: stretch;
        }

        .product-card {
            border: 1px solid var(--light-silver);
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s, box-shadow 0.3s;
            background: #fff;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            position: relative;
            overflow: hidden;
            width: 100%;
            padding-bottom: 14px;
            /* extra space for CTAs */
        }

        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
            z-index: 10;
        }

        .product-image-box {
            width: 100%;
            max-width: 120px;
            aspect-ratio: 1/1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f9f9f9;
            border-radius: 6px;
            margin-bottom: 8px;
            overflow: hidden;
            position: relative;
            padding: 6px;
            flex: 0 0 auto;
        }

        .product-card img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 4px;
            transition: transform 0.25s ease-in-out, box-shadow 0.25s;
            transform-origin: center center;
            display: block;
            max-width: 100%;
            max-height: 100%;
        }

        .product-card:hover .product-image-box img {
            transform: scale(1.15);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.12);
        }

        .product-card a {
            text-decoration: none;
            color: var(--dark-text);
            display: block;
            position: relative;
            z-index: 1;
        }

        .product-card h3 {
            font-size: 1.05em;
            margin: 6px 0 0;
            position: relative;
            z-index: 1;
            color: var(--dark-text);
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.15em;
            max-height: 2.3em;
            word-wrap: break-word;
            margin-bottom: 6px;
        }

        .product-card .meta {
            flex: 0 0 auto;
            width: 100%;
        }

        .product-card .price {
            font-weight: bold;
            color: #cc0000;
            margin-top: 4px;
            display: block;
            position: relative;
            z-index: 1;
            overflow-wrap: break-word;
        }

        .product-card .discounted-price {
            font-weight: bold;
            color: #27ae60;
            font-size: 1.08em;
            margin-top: 2px;
            display: block;
            position: relative;
            z-index: 1;
            overflow-wrap: break-word;
        }

        /*
         * Product action buttons
         * - Make the actions flex-wrap so they never overflow the card
         * - Use flexible/bounded widths for buttons so they fit side-by-side where possible
         * - Remove hard min-width that caused overflow, use min-width:0 so flex can shrink
         */
        .product-card .product-actions {
            position: relative;
            z-index: 1;
            display: flex;
            gap: 8px;
            margin-top: 10px;
            width: 100%;
            justify-content: space-between;
            align-items: center;
            flex: 0 0 auto;
            padding-top: 6px;
            flex-wrap: wrap;
            /* allow wrapping to avoid overflow */
            box-sizing: border-box;
        }

        /* Generic action button (kept small and tidy) */
        .product-actions .action-button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            /* use flexible basis so two buttons fit side-by-side, but allow shrinking */
            flex: 0 1 calc(50% - 4px);
            padding: 6px 8px;
            font-size: 0.88rem;
            cursor: pointer;
            border-radius: var(--btn-radius);
            transition: background-color 0.18s, transform 0.08s, color 0.18s;
            /* allow the button text to wrap instead of overflowing or being cropped */
            white-space: normal;
            overflow-wrap: anywhere;
            word-break: break-word;
            font-weight: 700;
            box-shadow: none;
            min-width: 0;
            /* allow shrinking inside flex container */
            max-width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.1;
        }

        /* Primary buy-now button (teal, compact) */
        .product-actions .action-button.buy-now {
            background: var(--cta-primary-bg);
            color: var(--cta-primary-color);
            border: 1px solid rgba(0, 0, 0, 0.06);
            box-shadow: var(--btn-shadow);
            padding: 7px 10px;
            font-size: 0.82rem;
            /* ensure icon + text won't push size beyond container; allow wrapping */
            white-space: normal;
            overflow-wrap: anywhere;
        }

        .product-actions .action-button.buy-now:hover,
        .product-actions .action-button.buy-now:focus {
            background: var(--cta-primary-hover);
            transform: translateY(-1px);
            outline: none;
        }

        /* Secondary wishlist button (subtle light box) */
        .product-actions .action-button.wishlist-btn {
            background: var(--cta-secondary-bg);
            color: var(--cta-secondary-color);
            border: 1px solid var(--cta-secondary-border);
            padding: 7px 10px;
            font-size: 0.9rem;
            white-space: normal;
            overflow-wrap: anywhere;
        }

        .product-actions .action-button.wishlist-btn:hover,
        .product-actions .action-button.wishlist-btn:focus {
            background: #efefef;
            color: #9e9e9e;
            transform: translateY(-1px);
            outline: none;
        }

        /* Wishlist added state (filled heart) */
        .product-actions .action-button.wishlist-btn.wish-added {
            background: #fff1f5;
            border-color: #f48fb1;
            color: #c2185b;
        }

        /* Responsive adjustments: stack buttons on small screens */
        @media (max-width: 600px) {
            .product-actions {
                flex-direction: column;
                gap: 8px;
            }

            .product-actions .action-button {
                width: 100%;
                flex: 1 1 100%;
                min-width: 0;
                justify-content: center;
            }
        }

        .sold-out {
            color: red;
            font-weight: bold;
            margin-top: 5px;
            display: block;
            position: relative;
            z-index: 1;
            font-size: 0.95em;
        }

        .footer {
            background-color: var(--light-brown);
            color: var(--dark-text);
            padding: 26px 12px 10px !important;
            border-top: 1px solid var(--light-silver);
        }

        .footer-container {
            display: flex;
            justify-content: space-between;
            max-width: 1200px;
            margin: 0 auto;
            text-align: left;
            flex-wrap: wrap;
        }

        .footer-section {
            flex: 1;
            min-width: 250px;
            margin-bottom: 20px;
        }

        .footer-section h4 {
            font-size: 18px;
            margin-bottom: 15px;
            color: var(--dark-accent);
        }

        .social-icons a {
            font-size: 24px;
            color: var(--dark-text);
            text-decoration: none;
            margin-right: 15px;
            transition: color 0.3s;
        }

        .payment-methods {
            margin-top: 20px;
            font-size: 28px;
        }

        .payment-methods span {
            margin-right: 10px;
            color: var(--footer-link-color);
        }

        .footer-section p,
        .footer-section a {
            color: var(--footer-link-color);
            text-decoration: none;
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            transition: color 0.3s;
        }

        .footer-bottom {
            text-align: center;
            margin-top: 30px;
            padding-top: 15px;
            border-top: 1px solid rgba(62, 39, 35, 0.1);
            font-size: 12px;
            color: var(--footer-link-color);
        }

        /* Modal styles retained below (unchanged) */
        .cart-modal-bg {
            display: none;
            position: fixed;
            left: 0;
            top: 0;
            height: 100vh;
            width: 100vw;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.4);
            z-index: 2000;
        }

        .cart-modal-content {
            background: #fff;
            width: 720px;
            max-width: 96%;
            border-radius: 10px;
            padding: 16px;
            box-shadow: 0 14px 40px rgba(0, 0, 0, 0.25);
            position: relative;
        }

        .cart-modal-close {
            background: none;
            border: none;
            font-size: 18px;
            position: absolute;
            right: 12px;
            top: 10px;
            cursor: pointer;
        }

        .small-muted {
            font-size: 0.95em;
            color: #666;
        }
    </style>
</head>

<body>
    {% include 'announcements.html' %}

    <nav class="navbar" role="navigation" aria-label="Main navigation">
        <div style="display:flex;align-items:center;gap:12px;">
            <a class="brand-logo" href="{{ url_for('main.index') }}">WPerfumes</a>
            <ul class="nav-tabs" role="menubar" aria-label="Site Menu">
                <li><a href="{{ url_for('main.index') }}">Home</a></li>
                <li><a href="{{ url_for('main.men') }}">Men</a></li>
                <li><a href="{{ url_for('main.women') }}">Women</a></li>
                <li><a href="{{ url_for('main.beauty') }}">Beauty</a></li>
                <li><a href="{{ url_for('main.history') }}">History</a></li>
                <li><a href="{{ url_for('main.about') }}">About Us</a></li>
            </ul>
        </div>

        <div class="navbar-center">
            <div class="search-container"><input id="siteSearchInput" type="text"
                    placeholder="Search for scents, notes, or brands..." aria-label="Search"></div>
        </div>

        <div class="navbar-right">
            <a id="cartBtn" class="cart-btn" href="{{ url_for('main.cart') }}" aria-label="Open cart">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#3e2723" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                    <circle cx="9" cy="21" r="1"></circle>
                    <circle cx="20" cy="21" r="1"></circle>
                    <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61l1.38-8.19H6"></path>
                </svg>
                <span>Cart</span>
                <span id="cartCountBadge" class="cart-count-badge" style="display:none;">0</span>
            </a>

            <div class="login-menu-container">
                <a href="{{ url_for('main.login_page') }}" class="login-btn">Login</a>
                <div class="login-submenu">
                    <a href="{{ url_for('main.signup') }}" class="signup-btn">Sign Up</a>
                </div>
            </div>
        </div>
    </nav>

    <main class="content-container">
        <h1 id="brandHeader">Brand Fragrances</h1>
        <p id="brandDesc" style="font-style: italic;">Loading brand description...</p>
        <div id="discountPercentInfo" class="discount-info" style="display:none;"></div>
        <div class="product-grid" id="productGrid"></div>
    </main>

    <footer class="main-footer">
        <div class="footer-card footer-card-1">
            <div>
                <h3>Connect with Us</h3>
                <div class="social-icons-row">
                    <a href="https://www.facebook.com/wperfumes" class="social-icon"
                        aria-label="Follow us on Facebook"><i class="fab fa-facebook-f"></i></a>
                    <a href="https://www.instagram.com/wperfumes" class="social-icon"
                        aria-label="Follow us on Instagram"><i class="fab fa-instagram"></i></a>
                    <a href="https://www.tiktok.com/@wperfumes" class="social-icon" aria-label="Follow us on TikTok"><i
                            class="fab fa-tiktok"></i></a>
                    <a href="https://www.twitter.com/wperfumes" class="social-icon" aria-label="Follow us on Twitter"><i
                            class="fab fa-x-twitter"></i></a>
                </div>
                <h3>Secure Payments</h3>
                <div class="payment-icons-row">
                    <span class="payment-icon" aria-label="Visa Payment"><i class="fab fa-cc-visa"></i></span>
                    <span class="payment-icon" aria-label="PayPal Payment"><i class="fab fa-cc-paypal"></i></span>
                    <span class="payment-icon" aria-label="Apple Pay"><i class="fab fa-cc-apple-pay"></i></span>
                    <span class="payment-icon" aria-label="MasterCard Payment"><i
                            class="fab fa-cc-mastercard"></i></span>
                </div>
            </div>
            <p class="registration-number" id="copyright">
                &copy; WPerfumes, Inc. All Rights Reserved.<br>
                Company Reg. No: 12345678A
            </p>
        </div>
        <div class="footer-card footer-card-2">
            <h2 class="footer-logo">WPerfumes</h2>
            <div class="footer-link-column">
                <h4>Company</h4>
                <a href="/about" class="footer-link">About Us</a>
                <a href="/vision" class="footer-link">Our Vision</a>
                <a href="/sustainability" class="footer-link">Sustainability</a>
                <a href="/careers" class="footer-link">Careers</a>
            </div>
            <div class="footer-link-column">
                <h4>Support</h4>
                <a href="/contact" class="footer-link">Contact Us</a>
                <a href="/faq" class="footer-link">FAQ</a>
                <a href="/shipping-returns" class="footer-link">Shipping & Returns</a>
                <a href="/privacy" class="footer-link">Privacy Policy</a>
            </div>
            <div class="footer-link-column">
                <h4>Explore</h4>
                <a href="/best-sellers" class="footer-link">Best Sellers</a>
                <a href="/gift-sets" class="footer-link">Gift Sets</a>
                <a href="/scent-finder" class="footer-link">Scent Finder Quiz</a>
                <a href="/blog" class="footer-link">Blog & News</a>
            </div>
            <div class="footer-link-column">
                <h4>Contact Info</h4>
                <a href="mailto:support@wperfumes.com" class="footer-link">Email: support@wperfumes.com</a>
                <a href="tel:+15551234567" class="footer-link">Phone: +1 (555) 123-4567</a>
                <a href="/contact#address" class="footer-link">Address: 100 Scent Lane, Perfume City</a>
            </div>
        </div>
    </footer>

    <div id="productDetailOverlay" aria-hidden="true">
        <button id="overlayCloseBtn" title="Close overlay">âœ•</button>
        <div id="overlayContent"></div>
    </div>

    <div id="cartModalBg" class="cart-modal-bg" aria-hidden="true">
        <div class="cart-modal-content" id="cartModal" role="dialog" aria-modal="true" aria-label="Cart">
            <button id="cartModalCloseBtn" class="cart-modal-close" aria-label="Close cart">âœ•</button>
            <div class="cart-modal-header">
                <div>Shopping Cart</div>
            </div>

            <div id="cartDiscountInfo" class="discount-info" style="display:none;"></div>

            <div id="cartList" class="cart-list" aria-live="polite"></div>

            <div class="cart-modal-footer">
                <div id="cartModalTotal" class="cart-modal-total"></div>
                <div style="flex:1"></div>
                <a id="openCheckoutFromCart" class="btn-primary" href="{{ url_for('main.checkout') }}"
                    style="background:#2d8f7c;color:#fff;padding:8px 12px;border-radius:6px;border:none;cursor:pointer;">Checkout</a>
            </div>
        </div>
    </div>

    <div id="checkoutModalBg" class="cart-modal-bg" aria-hidden="true">
        <div id="checkoutModalContent" role="dialog" aria-modal="true" aria-label="Checkout" class="cart-modal-content">
            <button id="checkoutModalCloseBtn" aria-label="Close checkout" class="cart-modal-close">âœ•</button>
            <h2>Checkout</h2>
            <div id="checkoutDiscountInfo" class="discount-info" style="display:none"></div>
            <div id="promoWrapper" style="margin-top:12px;">
                <label for="promoInput">Promo code</label>
                <div style="display:flex;gap:8px;align-items:center;">
                    <input id="promoInput" type="text" placeholder="Enter promo code"
                        style="flex:1;padding:8px;border:1px solid #ddd;border-radius:6px;">
                    <button id="applyPromoBtn" type="button"
                        style="padding:8px 10px;border-radius:6px;border:none;background:#2d8f7c;color:white;cursor:pointer;">Apply</button>
                </div>
                <div id="promoMsg" style="margin-top:8px;color:#666;font-size:0.95em;"></div>
            </div>

            <div id="cartSection" aria-live="polite"></div>

            <div id="paymentSelectWrapper" style="display:block;margin-top:12px;">
                <label class="payment-dropdown-label">Select Payment Method</label>
                <select id="paymentSelect" class="payment-select">
                    <option>Cash on Delivery</option>
                    <option>Visa/Mastercard</option>
                </select>
            </div>

            <form id="orderForm" style="margin-top:12px;">
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                    <input id="customer" name="customer" type="text" placeholder="Full name" required
                        style="padding:8px;border:1px solid #ddd;border-radius:6px;">
                    <input id="email" name="email" type="email" placeholder="Email" required
                        style="padding:8px;border:1px solid #ddd;border-radius:6px;">
                    <input id="phone" name="phone" type="text" placeholder="Phone"
                        style="padding:8px;border:1px solid #ddd;border-radius:6px;">
                    <input id="date" name="date" type="datetime-local"
                        style="padding:8px;border:1px solid #ddd;border-radius:6px;">
                </div>
                <div style="margin-top:10px;">
                    <textarea id="address" name="address" rows="3" placeholder="Shipping address"
                        style="width:100%;padding:8px;border:1px solid #ddd;border-radius:6px;"></textarea>
                </div>
                <div id="orderMsg" style="margin-top:10px;"></div>
                <div class="form-buttons" style="margin-top:12px;">
                    <button id="checkoutBtn" type="submit"
                        style="background:#2d8f7c;color:#fff;padding:8px 12px;border-radius:6px;border:none;cursor:pointer;">Place
                        Order</button>
                    <button id="buyNowBtn" type="button"
                        style="background:#27ae60;color:#fff;padding:8px 12px;border-radius:6px;border:none;cursor:pointer;">Buy
                        Now</button>
                </div>
            </form>
        </div>
    </div>

    <div id="orderConfirmationModalBg" class="cart-modal-bg" style="display:none;">
        <div id="orderConfirmationModalContent" class="cart-modal-content" style="max-width:400px;text-align:center;">
            <button id="orderConfirmationModalCloseBtn" title="Close"
                style="position:absolute;top:10px;right:18px;font-size:1.5em;background:none;border:none;cursor:pointer;">&times;</button>
            <div id="orderConfirmationMsg" style="margin:40px 0 15px 0;"></div>
        </div>
    </div>

    <div id="dynamicTopPicksByLifestyleContainer" style="display:none;"></div>
    <div id="homepage-sections"></div>

    <script>
        (function () {
            const ORIGINAL_FETCH = window.fetch.bind(window);
            window.fetch = function (input, init) {
                try {
                    if (input && typeof input === 'object' && input.url) {
                        let newUrl = input.url;
                        if (typeof newUrl === 'string' && newUrl.indexOf('http://127.0.0.1:5000') === 0) {
                            newUrl = newUrl.replace('http://127.0.0.1:5000', '');
                            input = new Request(newUrl, input);
                        }
                    } else if (typeof input === 'string') {
                        if (input.indexOf('http://127.0.0.1:5000') === 0) {
                            input = input.replace('http://127.0.0.1:5000', '');
                        }
                    }
                } catch (e) { }
                return ORIGINAL_FETCH(input, init);
            };
        })();
    </script>

    <script>
        const API = "/api";

        function toStaticUrl(url) {
            const placeholder = "{{ url_for('static', filename='images/placeholder.jpg') }}";
            if (!url) return placeholder;
            if (typeof url !== 'string') return placeholder;
            if (url.startsWith('http://') || url.startsWith('https://') || url.startsWith('/')) return url;
            return `/static/${url}`;
        }

        async function fetchDiscountPercent() {
            try {
                const r = await fetch(`${API}/settings/checkout_discount`);
                if (!r.ok) return 0;
                const js = await r.json();
                return parseFloat(js.percent) || 0;
            } catch (err) {
                console.warn('fetchDiscountPercent error', err);
                return 0;
            }
        }

        async function showDiscountBanner() {
            const percent = await fetchDiscountPercent();
            const discountInfoDiv = document.getElementById('discountPercentInfo');
            if (!discountInfoDiv) return;
            if (percent > 0) {
                discountInfoDiv.style.display = "block";
                discountInfoDiv.innerHTML = `<span>ðŸŒŸ <b>Special Offer:</b> <span style="color:#27ae60">${percent}% OFF</span> applied automatically at checkout & in your cart!</span>`;
            } else {
                discountInfoDiv.style.display = "none";
            }
        }
        showDiscountBanner();

        // --- helpers for local cart & UI ---
        function getCart() { return JSON.parse(localStorage.getItem('cart') || '[]'); }
        function saveCart(cart) { localStorage.setItem('cart', JSON.stringify(cart)); }
        function formatPrice(value) { return `$${(Number(value) || 0).toFixed(2)}`; }

        function updateCartBadge() {
            const badge = document.getElementById('cartCountBadge');
            const cart = getCart();
            if (!badge) return;
            const count = (cart || []).reduce((s, it) => s + (parseInt(it.quantity || it.qty || 1) || 0), 0);
            if (count > 0) {
                badge.style.display = 'inline-block';
                badge.textContent = count;
            } else {
                badge.style.display = 'none';
            }
        }

        // Renders the checkout modal content (list + subtotal + discount)
        function renderCheckoutModalCart() {
            const cart = getCart() || [];
            const section = document.getElementById('cartSection');
            const discountDiv = document.getElementById('checkoutDiscountInfo');
            if (!section) return;
            if (!cart.length) {
                section.innerHTML = '<div class="empty-cart">Your cart is empty.</div>';
                if (discountDiv) discountDiv.style.display = 'none';
                return;
            }

            let subtotal = 0;
            let html = '<table style="width:100%;border-collapse:collapse;margin-bottom:12px;"><thead><tr><th style="text-align:left">Product</th><th style="text-align:center;width:72px;">Qty</th><th style="text-align:right">Total</th></tr></thead><tbody>';
            cart.forEach(item => {
                const qty = parseInt(item.quantity || item.qty || 1);
                const price = parseFloat(item.price || 0);
                const total = price * qty;
                subtotal += total;
                const img = toStaticUrl(item.image || item.image_url || '');
                html += `<tr style="border-bottom:1px solid #eee;"><td style="padding:8px 6px;">
                    <div style="display:flex;gap:10px;align-items:center;">
                        <img src="${img}" alt="${(item.title || item.name || '')}" style="width:56px;height:56px;object-fit:contain;border-radius:6px;background:#fff;border:1px solid #eee;">
                        <div style="min-width:0;">
                            <div style="font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:200px;">${item.title || item.name || ''}</div>
                            <div class="small-muted" style="font-size:13px">${item.brand || ''}</div>
                            <div class="small-muted" style="font-size:13px">${formatPrice(price)} each</div>
                        </div>
                    </div>
                </td><td style="text-align:center;">${qty}</td><td style="text-align:right;">${formatPrice(total)}</td></tr>`;
            });
            html += '</tbody></table>';

            const discountPercent = (window.checkoutDiscountPercent || 0);
            const discountedTotal = subtotal * (1 - (discountPercent / 100));
            if (discountPercent > 0) {
                if (discountDiv) {
                    discountDiv.style.display = 'block';
                    discountDiv.innerHTML = `ðŸŒŸ <b>Special Offer:</b> <span style="color:#27ae60">${discountPercent}% OFF</span> applied automatically!`;
                }
                html += `<div style="display:flex;gap:12px;align-items:center;justify-content:space-between;margin-top:6px;">
                    <div style="font-weight:700;">Subtotal</div><div style="font-weight:700;">${formatPrice(subtotal)}</div>
                </div>
                <div style="display:flex;gap:12px;align-items:center;justify-content:space-between;margin-top:6px;">
                    <div style="font-weight:700;color:#27ae60;">Total (after discount)</div><div style="font-weight:700;color:#27ae60;">${formatPrice(discountedTotal)}</div>
                </div>`;
            } else {
                if (discountDiv) discountDiv.style.display = 'none';
                html += `<div style="display:flex;gap:12px;align-items:center;justify-content:space-between;margin-top:6px;">
                    <div style="font-weight:700;">Total</div><div style="font-weight:700;">${formatPrice(subtotal)}</div>
                </div>`;
            }

            // small actions: go to full checkout page or continue to place order in modal
            html += `<div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end;">
                <button id="continueToCheckoutBtn" style="background:#2d8f7c;color:#fff;padding:8px 12px;border-radius:6px;border:none;cursor:pointer;">Proceed to Checkout</button>
                <button id="closeCheckoutPreviewBtn" style="background:#f0f0f0;color:#222;padding:8px 12px;border-radius:6px;border:1px solid #e6e6e6;cursor:pointer;">Continue Shopping</button>
            </div>`;

            section.innerHTML = html;

            // attach handlers
            document.getElementById('continueToCheckoutBtn').addEventListener('click', function () {
                // navigate to dedicated checkout page; keep the cart in localStorage
                window.location.href = "{{ url_for('main.checkout') }}";
            });
            document.getElementById('closeCheckoutPreviewBtn').addEventListener('click', function () {
                closeCheckoutModal();
            });
        }

        // --- New: render the in-page Cart modal (so cart tab opens modal instead of navigating) ---
        function renderCartModal() {
            const cart = getCart() || [];
            const list = document.getElementById('cartList');
            const totalEl = document.getElementById('cartModalTotal');
            const discountDiv = document.getElementById('cartDiscountInfo');
            if (!list) return;
            if (!cart.length) {
                list.innerHTML = '<div class="cart-modal-empty">Your cart is empty.</div>';
                if (totalEl) totalEl.textContent = '';
                if (discountDiv) discountDiv.style.display = 'none';
                return;
            }

            let html = '';
            let total = 0;
            cart.forEach((item, idx) => {
                const qty = parseInt(item.quantity || item.qty || 1);
                const price = parseFloat(item.price || 0);
                const line = price * qty;
                total += line;
                const img = toStaticUrl(item.image || item.image_url || '');
                html += `
                <div class="cart-list-item" data-idx="${idx}" style="display:flex;gap:10px;padding:10px 6px;border-bottom:1px solid #eee;align-items:center;">
                    <img src="${img}" alt="${item.title || ''}" style="width:64px;height:64px;object-fit:contain;border-radius:6px;background:#fff;border:1px solid #eee;">
                    <div style="flex:1;min-width:0;">
                        <div style="font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${item.title || ''}</div>
                        <div class="small-muted">${item.brand || ''}</div>
                        <div style="margin-top:6px;display:flex;gap:8px;align-items:center;">
                            <button type="button" data-idx="${idx}" data-change="-1" class="cart-qty-btn" style="padding:6px 8px;border-radius:6px;border:1px solid #ddd;background:#fff;cursor:pointer;">-</button>
                            <span class="cart-qty-display" style="min-width:28px;text-align:center;display:inline-block;">${qty}</span>
                            <button type="button" data-idx="${idx}" data-change="1" class="cart-qty-btn" style="padding:6px 8px;border-radius:6px;border:1px solid #ddd;background:#fff;cursor:pointer;">+</button>
                        </div>
                    </div>
                    <div style="text-align:right;min-width:90px;">
                        <div style="font-weight:700;">${formatPrice(line)}</div>
                        <button type="button" data-remove-idx="${idx}" class="cart-remove-btn" style="margin-top:8px;background:#e74c3c;color:#fff;border:none;padding:6px 8px;border-radius:6px;cursor:pointer;">Remove</button>
                    </div>
                </div>`;
            });

            list.innerHTML = html;
            if (totalEl) totalEl.innerHTML = `<div style="font-weight:700;">Total: ${formatPrice(total)}</div>`;

            // attach qty and remove handlers
            list.querySelectorAll('.cart-qty-btn').forEach(btn => {
                btn.addEventListener('click', function (e) {
                    const idx = parseInt(this.getAttribute('data-idx'));
                    const change = parseInt(this.getAttribute('data-change'));
                    if (!isNaN(idx)) window.updateCartModalQuantity(idx, change);
                });
            });
            list.querySelectorAll('.cart-remove-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    const ridx = parseInt(this.getAttribute('data-remove-idx'));
                    if (!isNaN(ridx)) {
                        let c = getCart();
                        c.splice(ridx, 1);
                        saveCart(c);
                        updateCartBadge();
                        renderCartModal();
                    }
                });
            });

            // show discount info if available
            const discountPercent = (window.checkoutDiscountPercent || 0);
            if (discountPercent > 0 && discountDiv) {
                discountDiv.style.display = 'block';
                discountDiv.innerHTML = `ðŸŒŸ <b>Special Offer:</b> <span style="color:#27ae60">${discountPercent}% OFF</span> applied automatically!`;
            } else if (discountDiv) {
                discountDiv.style.display = 'none';
            }
        }

        // quantity update helper used by the cart modal
        window.updateCartModalQuantity = function (idx, change) {
            let cart = getCart() || [];
            if (!cart[idx]) return;
            const currentQty = parseInt(cart[idx].quantity || cart[idx].qty || 1);
            const newQty = currentQty + change;
            if (newQty > 0) {
                cart[idx].quantity = newQty;
            } else {
                cart.splice(idx, 1);
            }
            saveCart(cart);
            updateCartBadge();
            renderCartModal();
        };

        function openCheckoutModal() {
            const bg = document.getElementById('checkoutModalBg');
            if (!bg) return;
            bg.style.display = 'flex';
            bg.style.alignItems = 'center';
            bg.style.justifyContent = 'center';
            renderCheckoutModalCart();
        }

        function closeCheckoutModal() {
            const bg = document.getElementById('checkoutModalBg');
            if (!bg) return;
            bg.style.display = 'none';
        }

        // ensure close button works
        document.addEventListener('click', function (e) {
            if (e.target && e.target.id === 'checkoutModalCloseBtn') {
                closeCheckoutModal();
            }
            if (e.target && e.target.id === 'cartModalCloseBtn') {
                const cb = document.getElementById('cartModalBg');
                if (cb) cb.style.display = 'none';
            }
        });

        // --- ensure cart tab opens modal instead of navigating away ---
        document.addEventListener('DOMContentLoaded', function () {
            const cartBtn = document.getElementById('cartBtn');
            if (cartBtn) {
                cartBtn.addEventListener('click', function (e) {
                    // if cart modal exists on the page, open it in-place and prevent navigation
                    const modalExists = !!document.getElementById('cartModalBg');
                    if (modalExists) {
                        e.preventDefault();
                        renderCartModal();
                        const cb = document.getElementById('cartModalBg');
                        if (cb) cb.style.display = 'flex';
                        return;
                    }
                });
            }

            // existing page initialization...
            const params = new URLSearchParams(window.location.search);
            const brandParamRaw = params.get('brand') || '';
            const brandForDisplay = decodeURIComponent(brandParamRaw).replace(/_/g, ' ').trim();
            const brandForApi = encodeURIComponent((brandForDisplay || '').replace(/ /g, '_'));

            document.getElementById('brandHeader').textContent = brandForDisplay ? `House of ${brandForDisplay} Fragrances` : "Brand Fragrances";
            document.getElementById('brandTitle').textContent = brandForDisplay ? `${brandForDisplay} Fragrances` : "Brand Fragrances";

            fetch(`${API}/brands`)
                .then(res => {
                    if (!res.ok) throw new Error('Failed to fetch brands');
                    return res.json();
                })
                .then(brands => {
                    const b = brands.find(x => x.name === brandForDisplay);
                    if (b && b.description) {
                        document.getElementById('brandDesc').textContent = b.description;
                    } else {
                        document.getElementById('brandDesc').textContent = "";
                    }
                })
                .catch(err => {
                    console.warn('Error loading brands:', err);
                    document.getElementById('brandDesc').textContent = "";
                });

            const productsApiPath = brandForApi ? `${API}/products/${brandForApi}` : `${API}/products`;
            fetch(productsApiPath)
                .then(res => {
                    if (!res.ok) throw new Error('Failed to fetch products');
                    return res.json();
                })
                .then(products => {
                    const grid = document.getElementById('productGrid');
                    grid.innerHTML = '';
                    (products || []).forEach(product => {
                        // Robust product id extraction:
                        // Some backends return an object for _id (e.g. {_id: { $oid: "..." }}) or numeric id.
                        // Normalize to a string so product_detail can use the authoritative id when available.
                        let rawId = '';
                        if (product.id) {
                            rawId = product.id;
                        } else if (product._id) {
                            // _id might be a string, an object like { $oid: '...' }, or other shape.
                            if (typeof product._id === 'string') rawId = product._id;
                            else if (product._id.$oid) rawId = product._id.$oid;
                            else rawId = JSON.stringify(product._id);
                        } else {
                            rawId = '';
                        }
                        const pidRaw = rawId ? String(rawId) : '';
                        const pid = pidRaw ? encodeURIComponent(pidRaw) : '';

                        const priceVal = parseFloat(product.price || 0);
                        const discounted = (window.checkoutDiscountPercent && window.checkoutDiscountPercent > 0)
                            ? (priceVal * (1 - (window.checkoutDiscountPercent / 100)))
                            : priceVal;
                        const productSlug = encodeURIComponent((product.title || '').replace(/ /g, '_'));
                        const brandQuery = encodeURIComponent(brandForDisplay || product.brand || '');
                        // use product_id (encoded) in the link but keep a safe raw id for data-id attributes
                        const productLink = `/brand_detail?brand=${brandQuery}&product=${productSlug}${pid ? `&product_id=${pid}` : ''}`;

                        // Build product card HTML. Use pidRaw for data-id attributes so downstream scripts
                        // (which may expect the raw id) receive a normalized string.
                        grid.innerHTML += `
                        <div class="product-card">
                            <a href="${productLink}" title="View ${brandForDisplay || product.brand} ${product.title}">
                                <div class="product-image-box">
                                    <img src="${toStaticUrl(product.image_url)}" alt="${brandForDisplay || product.brand} ${product.title}">
                                </div>
                                <h3>${product.title}</h3>
                            </a>
                            <div class="meta">
                                <span class="price" style="${window.checkoutDiscountPercent > 0 ? 'text-decoration: line-through; color: #888;' : ''}">$${(priceVal).toFixed(2)}</span>
                                ${window.checkoutDiscountPercent > 0 ? `<span class="discounted-price">$${(discounted).toFixed(2)} <span style="font-size:0.92em;color:#888;">(-${window.checkoutDiscountPercent}% Off)</span></span>` : ''}
                                ${product.quantity === 0 ? '<span class="sold-out">Sold Out</span>' : ''}
                            </div>
                            <div class="product-actions">
                                <button class="action-button buy-now" data-id="${pidRaw}" data-title="${product.title}" data-brand="${product.brand}" data-price="${priceVal}" data-image="${product.image_url}" data-qty="1">âš¡ Buy Now</button>
                                <button class="action-button wishlist-btn" data-id="${pidRaw}" data-title="${product.title}" data-brand="${product.brand}" data-price="${priceVal}" data-image="${product.image_url}">â™¡ Wishlist</button>
                            </div>
                        </div>
                        `;
                    });

                    // BUY NOW handlers (replaces old add-to-cart behavior)
                    document.querySelectorAll('.buy-now').forEach(btn => {
                        btn.addEventListener('click', function (e) {
                            e.stopPropagation();
                            const pid = this.getAttribute('data-id') || (new Date().getTime() + '');
                            const title = this.getAttribute('data-title') || '';
                            const qty = parseInt(this.getAttribute('data-qty')) || 1;
                            const brand = this.getAttribute('data-brand') || '';
                            let priceVal = parseFloat(this.getAttribute('data-price') || 0);
                            if (!priceVal) {
                                const priceEl = this.closest('.product-card').querySelector('.discounted-price') || this.closest('.product-card').querySelector('.price');
                                const priceText = priceEl ? (priceEl.textContent || '') : '';
                                priceVal = parseFloat((priceText || '').replace(/[^0-9.]/g, '')) || 0;
                            }
                            const imageSrc = (this.getAttribute('data-image') && this.getAttribute('data-image').trim()) ? toStaticUrl(this.getAttribute('data-image')) : ((this.closest('.product-card').querySelector('img') || {}).src || '');

                            // POST order-attempts (best-effort)
                            fetch(`${API}/order-attempts`, {
                                method: "POST",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify({
                                    email: "",
                                    product: title,
                                    qty: qty,
                                    status: "Carted"
                                })
                            }).catch(() => { });

                            // update localStorage cart
                            let cart = JSON.parse(localStorage.getItem('cart') || "[]");
                            const existing = cart.find(i => ('' + i.id) === ('' + pid));
                            if (existing) {
                                existing.quantity = (existing.quantity || 0) + qty;
                            } else {
                                cart.push({
                                    id: pid,
                                    title: title,
                                    brand: brand,
                                    price: Number(priceVal) || 0,
                                    image: imageSrc,
                                    quantity: qty
                                });
                            }
                            localStorage.setItem('cart', JSON.stringify(cart));
                            updateCartBadge();

                            // open the checkout preview/modal showing item & price details (in-place)
                            openCheckoutModal();
                        });
                    });

                    // WISHLIST handlers (toggle localStorage wishlist)
                    document.querySelectorAll('.wishlist-btn').forEach(btn => {
                        const setState = (el, added) => {
                            if (added) {
                                el.classList.add('wish-added');
                                el.textContent = 'â™¥ Wishlist';
                            } else {
                                el.classList.remove('wish-added');
                                el.textContent = 'â™¡ Wishlist';
                            }
                        };
                        // initialize button state from localStorage
                        const wishlist = JSON.parse(localStorage.getItem('wishlist') || '[]');
                        const pid = btn.getAttribute('data-id');
                        if (wishlist.find(w => ('' + w.id) === ('' + pid))) {
                            setState(btn, true);
                        }

                        btn.addEventListener('click', function (e) {
                            e.stopPropagation();
                            const id = this.getAttribute('data-id') || (new Date().getTime() + '');
                            const title = this.getAttribute('data-title') || '';
                            const brand = this.getAttribute('data-brand') || '';
                            const price = parseFloat(this.getAttribute('data-price') || 0);
                            const image = this.getAttribute('data-image') ? toStaticUrl(this.getAttribute('data-image')) : '';
                            let list = JSON.parse(localStorage.getItem('wishlist') || '[]') || [];
                            const existingIndex = list.findIndex(i => ('' + i.id) === ('' + id));
                            if (existingIndex >= 0) {
                                // remove
                                list.splice(existingIndex, 1);
                                localStorage.setItem('wishlist', JSON.stringify(list));
                                setState(this, false);
                            } else {
                                // add
                                list.push({ id, title, brand, price, image });
                                localStorage.setItem('wishlist', JSON.stringify(list));
                                setState(this, true);
                            }
                        });
                    });

                    updateCartBadge();
                })
                .catch(err => {
                    console.warn('Error loading products:', err);
                });

            const openCheckoutBtn = document.getElementById('openCheckoutFromCart');
            if (openCheckoutBtn) {
                openCheckoutBtn.addEventListener('click', function (e) {
                    const href = openCheckoutBtn.getAttribute('href');
                    if (href && href !== '#' && href.trim() !== '') {
                        return;
                    }
                    e.preventDefault();
                    const cartBg = document.getElementById('cartModalBg');
                    if (cartBg) cartBg.style.display = 'none';
                    const checkoutBg = document.getElementById('checkoutModalBg');
                    if (checkoutBg) checkoutBg.style.display = 'flex';
                });
            }
            const overlayClose = document.getElementById('overlayCloseBtn');
            if (overlayClose) overlayClose.addEventListener('click', function () {
                const overlay = document.getElementById('productDetailOverlay');
                if (overlay) overlay.style.display = 'none';
            });
        });

        (async function initDiscountGlobal() {
            window.checkoutDiscountPercent = await fetchDiscountPercent();
        })();
    </script>

    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    <script src="{{ url_for('static', filename='js/announcements.js') }}"></script>
    <script src="{{ url_for('static', filename='js/footer.js') }}"></script>


</body>


</html>