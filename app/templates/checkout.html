<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Checkout - WPerfumes</title>

    <!-- Main CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">

    <style>
        /* Page-specific styles */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            background: #f6f8f8;
            color: #222;
        }

        .container {
            max-width: 820px;
            margin: 32px auto;
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.06);
            padding: 20px;
        }

        h2 {
            margin-top: 0;
            font-size: 22px;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 360px;
            gap: 20px;
        }

        .cart-summary {
            background: #fafafa;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #eee;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 14px;
        }

        th,
        td {
            padding: 8px 6px;
            border-bottom: 1px solid #eee;
            vertical-align: middle;
        }

        th {
            text-align: left;
            font-weight: 700;
            font-size: 14px;
        }

        .total-row td {
            font-weight: 700;
        }

        .form-group {
            margin-bottom: 10px;
        }

        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
        }

        input[type="text"],
        input[type="email"],
        textarea,
        select,
        input[type="datetime-local"] {
            width: 100%;
            padding: 8px 10px;
            border-radius: 6px;
            border: 1px solid #ddd;
            box-sizing: border-box;
        }

        textarea {
            min-height: 70px;
            resize: vertical;
        }

        .form-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            align-items: center;
        }

        .btn-primary,
        .checkout-link {
            background: #2d8f7c;
            color: #fff;
            padding: 10px 16px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 700;
            transition: transform 160ms ease, box-shadow 160ms ease, opacity 160ms ease;
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #222;
            padding: 10px 14px;
            border-radius: 8px;
            border: 1px solid #e6e6e6;
            cursor: pointer;
            font-weight: 700;
            transition: transform 160ms ease, box-shadow 160ms ease, opacity 160ms ease;
        }

        /* Active look */
        .btn-active {
            box-shadow: 0 6px 18px rgba(45, 143, 124, 0.18);
            transform: translateY(-2px);
        }

        /* Disabled look */
        .btn-disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
            filter: grayscale(10%);
            box-shadow: none !important;
            transform: none !important;
        }

        .discount-info {
            background: #fff8e6;
            color: #b8860b;
            padding: 8px 10px;
            border-radius: 6px;
            margin-bottom: 12px;
            border: 1px solid #f1e6c9;
            font-weight: 600;
        }

        .empty-cart {
            color: #e74c3c;
            padding: 18px 12px;
            text-align: center;
            border-radius: 6px;
            background: #fff6f6;
        }

        .small-muted {
            font-size: 0.95em;
            color: #666;
        }

        @media (max-width: 900px) {
            .grid {
                grid-template-columns: 1fr;
            }

            .container {
                margin: 16px;
                padding: 14px;
            }
        }
    </style>
</head>

<body>
    <div class="container" role="main" aria-labelledby="checkout-heading">
        <h2 id="checkout-heading">Checkout</h2>

        <div id="discountPercentInfo" class="discount-info" style="display:none;" aria-live="polite"></div>

        <div class="grid">
            <!-- Left: Order form -->
            <div>
                <form id="orderForm">
                    <div class="form-group">
                        <label for="customer">Full Name</label>
                        <input id="customer" name="customer" required type="text" autocomplete="name" />
                    </div>

                    <div class="form-group">
                        <label for="email">Email Address</label>
                        <input id="email" name="email" required type="email" autocomplete="email" />
                    </div>

                    <div class="form-group">
                        <label for="phone">Phone Number</label>
                        <input id="phone" name="phone" type="text" autocomplete="tel" />
                    </div>

                    <div class="form-group">
                        <label for="address">Shipping Address</label>
                        <textarea id="address" name="address" rows="3" required></textarea>
                    </div>

                    <input type="hidden" id="promo_code_hidden" name="promo_code" value="">

                    <div class="form-group">
                        <label for="paymentSelect">Select Payment Method</label>
                        <select id="paymentSelect" name="payment_method" class="payment-select" required>
                            <option value="Cash on Delivery" selected>Cash on Delivery</option>
                            <option value="Visa/Mastercard">Visa/Mastercard</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="date">Desired Delivery / Order Date</label>
                        <input id="date" name="date" type="datetime-local" />
                    </div>

                    <div class="form-buttons">
                        <button type="submit" id="checkoutBtn" class="btn-primary">Place Order</button>
                        <button type="button" id="buyNowBtn" class="btn-secondary">Buy Now</button>
                        <!-- Inline hint to explain disabled state (aria-live) -->
                        <div id="paymentHint" class="small-muted" aria-live="polite" style="margin-left:8px;"></div>
                    </div>

                    <div id="orderMsg" style="margin-top:12px;"></div>
                </form>
            </div>

            <!-- Right: Cart summary -->
            <aside class="cart-summary" aria-label="Cart summary">
                <h3 style="margin-top:0;margin-bottom:8px;">Order Summary</h3>

                <div style="margin-bottom:12px;">
                    <label for="promo_code_summary" style="font-weight:700;margin-bottom:6px;display:block;">Promo
                        Code</label>
                    <select id="promo_code_summary" name="promo_code_summary"
                        style="width:100%;padding:8px;border-radius:6px;border:1px solid #ddd;">
                        <option value="">-- None --</option>
                    </select>
                    <div id="promoMsg" class="small-muted" style="margin-top:8px;"></div>
                </div>

                <div id="cartSummarySection" aria-live="polite"></div>
                <div style="margin-top:12px;">
                    <div class="small-muted">Payment on delivery available for eligible addresses.</div>
                </div>
            </aside>
        </div>
    </div>

    <script>
        // Use relative API base so this works in deployment and locally
        const API = "/api";

        function toStaticUrl(url) {
            const placeholder = "{{ url_for('static', filename='images/placeholder.jpg') }}";
            if (!url) return placeholder;
            if (typeof url !== 'string') return placeholder;
            if (url.startsWith('http://') || url.startsWith('https://') || url.startsWith('/')) return url;
            return `/static/${url}`;
        }

        function formatPriceInteger(value) {
            const n = Number(value) || 0;
            return `$${Math.round(n)}`;
        }

        function getCart() { return JSON.parse(localStorage.getItem('cart') || '[]'); }
        function saveCart(cart) { localStorage.setItem('cart', JSON.stringify(cart)); }

        let checkoutDiscountPercent = 0;
        async function fetchDiscountPercent() {
            try {
                const r = await fetch(`${API}/settings/checkout_discount`);
                if (!r.ok) {
                    checkoutDiscountPercent = 0;
                    document.getElementById('discountPercentInfo').style.display = 'none';
                    return;
                }
                const js = await r.json();
                checkoutDiscountPercent = parseFloat(js.percent) || 0;
                const div = document.getElementById('discountPercentInfo');
                if (checkoutDiscountPercent > 0) {
                    div.style.display = 'block';
                    div.innerHTML = `ðŸŒŸ <b>Special Offer:</b> <span style="color:#27ae60">${checkoutDiscountPercent}% OFF</span> applied automatically!`;
                } else {
                    div.style.display = 'none';
                }
            } catch (e) {
                console.warn('Failed to load discount', e);
                checkoutDiscountPercent = 0;
                document.getElementById('discountPercentInfo').style.display = 'none';
            }
        }

        let availablePromos = [];
        async function loadActivePromos() {
            const promoSelect = document.getElementById('promo_code_summary');
            try {
                const res = await fetch(`${API}/coupons`);
                if (!res.ok) {
                    availablePromos = [];
                    promoSelect.innerHTML = '<option value="">-- None --</option>';
                    return;
                }
                availablePromos = await res.json();
                const today = new Date().toISOString().slice(0, 10);
                let options = '<option value="">-- None --</option>';
                availablePromos.forEach(p => {
                    if (p.active &&
                        (!p.start_date || p.start_date <= today) &&
                        (!p.end_date || p.end_date >= today)) {
                        options += `<option value="${p.code}" data-percent="${p.percent || 0}">${p.code} ${p.description ? '(' + p.description + ')' : ''}</option>`;
                    }
                });
                promoSelect.innerHTML = options;
            } catch (e) {
                console.warn('Failed to load promos', e);
                availablePromos = [];
                promoSelect.innerHTML = '<option value="">-- None --</option>';
            }

            promoSelect.addEventListener('change', function () {
                const code = this.value || '';
                document.getElementById('promo_code_hidden').value = code;
                const found = availablePromos.find(x => x.code === code);
                const percent = found ? (parseFloat(found.percent) || 0) : 0;
                document.getElementById('promoMsg').innerText = percent > 0 ? `Promo will apply ${percent}% off.` : '';
                renderCartSummary();
            });
        }

        // Helper: set button visual & accessibility state
        function setButtonState(btn, enabled, reason) {
            if (!btn) return;
            btn.disabled = !enabled;
            if (enabled) {
                btn.classList.remove('btn-disabled');
                btn.classList.add('btn-active');
                btn.setAttribute('aria-disabled', 'false');
                btn.tabIndex = 0;
                btn.removeAttribute('title');
            } else {
                btn.classList.remove('btn-active');
                btn.classList.add('btn-disabled');
                btn.setAttribute('aria-disabled', 'true');
                btn.tabIndex = -1;
                if (reason) btn.setAttribute('title', reason);
            }
        }

        // Update button enabled/disabled and hint text based on payment selection + cart
        function updatePaymentButtonsStateCheckout() {
            const cart = getCart();
            const cartEmpty = !cart || !cart.length;
            const paymentEl = document.getElementById('paymentSelect');
            if (!paymentEl) return;
            const payment = paymentEl.value || 'Cash on Delivery';
            const placeBtn = document.getElementById('checkoutBtn');
            const buyBtn = document.getElementById('buyNowBtn');
            const hintEl = document.getElementById('paymentHint');

            if (cartEmpty) {
                setButtonState(placeBtn, false, 'Cart is empty');
                setButtonState(buyBtn, false, 'Cart is empty');
                if (hintEl) hintEl.innerText = 'Your cart is empty.';
                return;
            }

            if (payment === 'Cash on Delivery') {
                setButtonState(placeBtn, true);
                setButtonState(buyBtn, false, 'Buy Now requires card payment (Visa/Mastercard).');
                if (hintEl) hintEl.innerText = 'Cash on Delivery selected â€” use "Place Order".';
            } else {
                setButtonState(placeBtn, false, 'Place Order is disabled for card payments.');
                setButtonState(buyBtn, true);
                if (hintEl) hintEl.innerText = `${payment} selected â€” use "Buy Now" to pay with card.`;
            }
        }

        function renderCartSummary() {
            const cart = getCart();
            const container = document.getElementById('cartSummarySection');
            if (!cart || !cart.length) {
                container.innerHTML = '<div class="empty-cart">Your cart is empty.</div>';
                // we'll call updatePaymentButtonsStateCheckout() to sync visuals
                updatePaymentButtonsStateCheckout();
                return;
            }

            let html = `<table>
                <thead><tr><th>Product</th><th style="text-align:center;">Qty</th><th style="text-align:right;">Total</th></tr></thead>
                <tbody>`;
            let subtotal = 0;
            cart.forEach(item => {
                const qty = item.quantity || item.qty || 1;
                const price = parseFloat(item.price || 0);
                const itemTotal = price * qty;
                subtotal += itemTotal;
                html += `<tr>
                    <td style="padding:8px 6px;">
                        <div style="display:flex;gap:8px;align-items:center;">
                            <img src="${toStaticUrl(item.image || item.image_url || '')}" alt="${item.title || ''}" style="width:56px;height:56px;object-fit:contain;border-radius:6px;background:#fff;border:1px solid #eee;">
                            <div>
                                <div style="font-weight:600">${item.title || item.name || ''}</div>
                                <div class="small-muted" style="font-size:13px">${item.brand || ''}</div>
                            </div>
                        </div>
                    </td>
                    <td style="text-align:center;">${qty}</td>
                    <td style="text-align:right;">${formatPriceInteger(itemTotal)}</td>
                </tr>`;
            });
            const discountedTotal = subtotal * (1 - (checkoutDiscountPercent || 0) / 100);
            html += `</tbody>
                <tfoot>
                    <tr class="total-row"><td></td><td style="font-weight:700;">Subtotal</td><td style="text-align:right;font-weight:700;">${formatPriceInteger(subtotal)}</td></tr>
                    <tr class="total-row"><td></td><td style="font-weight:700;">Total (after discount)</td><td style="text-align:right;color:#27ae60;font-weight:700;">${formatPriceInteger(discountedTotal)}</td></tr>
                </tfoot>
            </table>`;
            container.innerHTML = html;

            // ensure buttons reflect payment selection and cart state
            updatePaymentButtonsStateCheckout();
        }

        async function submitOrders(customer, email, phone, address, payment_method, promo_code, date) {
            const cart = getCart();
            if (!cart || !cart.length) return { success: false, message: 'Cart empty' };
            const results = [];
            for (const item of cart) {
                const payload = {
                    customer_name: customer,
                    customer_email: email,
                    customer_phone: phone,
                    customer_address: address,
                    product_id: item.id || item.product_id || '',
                    product_title: item.title || item.name || '',
                    quantity: item.quantity || item.qty || 1,
                    status: "Pending",
                    payment_method: payment_method || "Cash on Delivery",
                    date: date || (new Date().toISOString().slice(0, 19).replace('T', ' '))
                };
                if (promo_code) payload.promo_code = promo_code;

                try {
                    const res = await fetch(`${API}/orders`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(payload)
                    });
                    if (!res.ok) {
                        const text = await res.text().catch(() => res.statusText);
                        results.push({ ok: false, message: text || `HTTP ${res.status}` });
                    } else {
                        results.push({ ok: true });
                    }
                } catch (e) {
                    results.push({ ok: false, message: e.message });
                }
            }
            return results;
        }

        async function logOrderAttemptsForCart(status = 'CheckedOut') {
            const cart = getCart() || [];
            for (const item of cart) {
                try {
                    await fetch(`${API}/order-attempts`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            email: "",
                            product: item.title || item.name || "",
                            qty: item.quantity || item.qty || 1,
                            status
                        })
                    });
                } catch (e) {
                    // ignore
                }
            }
        }

        document.getElementById('orderForm').addEventListener('submit', async function (e) {
            e.preventDefault();
            const customer = document.getElementById('customer').value || '';
            const email = document.getElementById('email').value || '';
            const phone = document.getElementById('phone').value || '';
            const address = document.getElementById('address').value || '';
            const payment_method = document.getElementById('paymentSelect').value || 'Cash on Delivery';
            const promo_code = document.getElementById('promo_code_summary').value || document.getElementById('promo_code_hidden').value || null;
            const dateVal = document.getElementById('date').value || new Date().toISOString().slice(0, 19).replace('T', ' ');

            const orderMsg = document.getElementById('orderMsg');
            orderMsg.innerHTML = '<span class="small-muted">Placing your order...</span>';
            setButtonState(document.getElementById('checkoutBtn'), false);
            setButtonState(document.getElementById('buyNowBtn'), false);

            await logOrderAttemptsForCart('CheckedOut');

            const results = await submitOrders(customer, email, phone, address, payment_method, promo_code, dateVal);

            const anyFailed = results.some(r => !r.ok);
            if (anyFailed) {
                orderMsg.innerHTML = '<div style="color:#e74c3c;font-weight:700;">One or more orders failed. See details below.</div>';
                results.forEach((r, i) => {
                    if (!r.ok) {
                        orderMsg.innerHTML += `<div style="color:#c44;">Item ${i + 1}: ${r.message || 'Failed'}</div>`;
                    }
                });
                // re-sync
                updatePaymentButtonsStateCheckout();
            } else {
                orderMsg.innerHTML = `<div style="color:#27ae60;font-weight:700;">Thank you! Your orders were placed successfully.</div>`;
                localStorage.removeItem('cart');
                renderCartSummary();
                setTimeout(() => {
                    window.location.href = "{{ url_for('index') }}";
                }, 2400);
            }
        });

        document.getElementById('buyNowBtn').addEventListener('click', async function () {
            const customer = document.getElementById('customer').value || '';
            const email = document.getElementById('email').value || '';
            const phone = document.getElementById('phone').value || '';
            const address = document.getElementById('address').value || '';
            const promo_code = document.getElementById('promo_code_summary').value || document.getElementById('promo_code_hidden').value || null;
            const dateVal = document.getElementById('date').value || new Date().toISOString().slice(0, 19).replace('T', ' ');

            const payment_method = 'Visa/Mastercard';

            const orderMsg = document.getElementById('orderMsg');
            orderMsg.innerHTML = '<span class="small-muted">Processing payment and placing your order...</span>';
            setButtonState(document.getElementById('checkoutBtn'), false);
            setButtonState(document.getElementById('buyNowBtn'), false);

            await logOrderAttemptsForCart('CheckedOut');

            const results = await submitOrders(customer, email, phone, address, payment_method, promo_code, dateVal);

            const anyFailed = results.some(r => !r.ok);
            if (anyFailed) {
                orderMsg.innerHTML = '<div style="color:#e74c3c;font-weight:700;">Order failed for one or more items.</div>';
                updatePaymentButtonsStateCheckout();
            } else {
                orderMsg.innerHTML = `<div style="color:#27ae60;font-weight:700;">Payment successful. Thank you! Redirecting...</div>`;
                localStorage.removeItem('cart');
                renderCartSummary();
                setTimeout(() => window.location.href = "{{ url_for('index') }}", 2000);
            }
        });

        // sync on select change
        document.getElementById('paymentSelect').addEventListener('change', updatePaymentButtonsStateCheckout);

        (async function init() {
            await fetchDiscountPercent();
            await loadActivePromos();
            renderCartSummary();
            updatePaymentButtonsStateCheckout();
            setInterval(async () => {
                const prev = checkoutDiscountPercent;
                await fetchDiscountPercent();
                if (prev !== checkoutDiscountPercent) renderCartSummary();
            }, 30000);
        })();
    </script>
</body>

</html>